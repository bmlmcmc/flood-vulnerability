setwd('D:/jurnal/pandi/sovi jakarta/data')
library(caret)
library(openxlsx)
library(rdist)
library(naspaclust)
library(cluster)
library(MASS)
library(ggplot2)
library(ggpubr)
library(tibble)
library(geosphere)
data <- read.xlsx('jkt-floodvuln-data-for-r-script.xlsx')
head(data)
pop <- data$Penduduk/1000
# pop <- (pop-min(pop))/(max(pop)-min(pop))+1

koord <- data[,c('Longitude','Latitude')]
distance <- pdist(koord)
distance <- c()
for(i in 1:nrow(koord)) distance <- rbind(distance,distHaversine(koord[i,],koord)/1000)
distance[1:5,1:5]

pca1 <- prcomp(scale(data[,-c(1:5)]))
summary(pca1)

data_risk <- scale(data[,-c(1:5)])
prepro <- preProcess(data[,-c(1:5)],method=c('range'))
data_risk <- predict(prepro, data[,-c(1:5)])
head(data_risk)


fpa_param <- c(vi.dist='normal',npar=10,same=15,p=0.7,
               gamma=1.2,lambda=1.5,ei.distr='circhaotic',chaos=3,map=0.6) 
param_fgwc <- c(ncluster=3,m=2,distance='minkowski',order=2,
                alpha=0.7,a=1,b=1,max.iter=1000,error=1e-6,randomN=15)
res<-fgwc(scale(data_risk[,-c(6,13,16:23)]),pop,distance,'fpa',param_fgwc,fpa_param)

res <- lapply(c('uniform','normal','logchaotic','kentchaotic',
                'sinechaotic','dyadchaotic','chebychaotic','circhaotic'),function(i){
  lapply(2:10, function(j) {
    lapply(1:100, function(k){
      fpa_param <- c(vi.dist='normal',npar=10,same=15,p=0.7,
                     gamma=1.2,lambda=1.5,ei.distr=i,chaos=3,map=0.6) 
      param_fgwc <- c(ncluster=j,m=1.5,distance='minkowski',order=2,
                      alpha=0.7,a=1,b=1,max.iter=500,error=1e-6,randomN=k)
      res<-fgwc(scale(data_risk[,-c(6,13,16:23)]),pop,distance,'fpa',param_fgwc,fpa_param)
    })
  })
})

a = aggregate(.~cluster,res[[2]][[2]]$finaldata,mean)

ss.cluster <- function(data,cluster){
  xbar <- colMeans(data)
  xbarr <- matrix(xbar, nrow=nrow(data), ncol=length(xbar), byrow=TRUE)
  sst <- sum((data-xbarr)^2)
  x.bar <- aggregate(.~cluster,data,mean)
  rownames(x.bar) <- sort(unique(cluster))
  # print(x.bar)
  x.barr <- x.bar[as.character(cluster),-1]
  ssw <- sum((data-x.barr)^2)
  return(c(sst,ssw,length(unique(cluster))))
}

distr <- c('uniform','normal','logchaotic','kentchaotic',
           'sinechaotic','dyadchaotic','chebychaotic','circhaotic')
summ <- data.frame()
for(i in 1:length(distr)){
  for(j in 1:9){
    for(k in 1:100){
      xx <- try(ss.cluster(res[[i]][[j]][[k]]$finaldata[,-26],res[[i]][[j]][[k]]$cluster),
                c(0,0))
      a <- silhouette(res[[i]][[j]][[k]]$cluster,pdist(data_risk[,-c(6,13,16:23)]))
      a <- mean(a[,3])
      summ <- rbind.data.frame(summ,c(distr[i],j+1,k,xx,a,res[[i]][[j]][[k]]$f_obj,
                                      unlist(res[[i]][[j]][[k]]$validation),
                                      res[[i]][[j]][[k]]$iteration,
                                      res[[i]][[j]][[k]]$time[3]))
    }
  }
}

colnames(summ) <- c('error','c','run','sst','ssw','clust.form','sil','obj',
                    names(res[[i]][[j]][[k]]$validation),'iter','time')
for(i in c(2:17)) summ[,i] <- as.numeric(summ[,i])
head(summ)

write.csv(meanres <- aggregate(.~error+c,summ,mean),'meanresult.csv')
write.csv(sdres <- aggregate(.~error+c,summ,sd),'sdresult.csv')
write.csv(medres <- aggregate(.~error+c,summ,median),'medianresult.csv')

summ$r2 <- 1-(summ$ssw/summ$sst)
summ$pf <- (summ$r2/(summ$c-1))/(1-summ$r2/(nrow(data_risk)-summ$c))
summ$icdr <- 1-summ$r2
summ[,c(1,2,3,13,14)]

ggplot(meanres,aes(x=c,y=PC,color=error,shape=error))+geom_line(size=1.5)+geom_point(size=3)
ggplot(meanres[meanres$error%in%c('logchaotic'),],
       aes(x=c,y=PC,color=error,shape=error))+
  geom_line(size=1.5)+geom_point(size=3)
cc


clusplot(data_risk,res[[2]][[5]]$cluster)
sam_res <- data.frame(sammon(pdist(data_risk))$points,cluster = res$cluster)

ggplot(sam_res,aes(x=X1,y=X2,shape=as.factor(cluster)))+
  geom_point(size=3)+geom_text(aes(label=data$nama_kecamatan,
                                   color=data$nama_kabupaten_kota),
                               hjust=0, vjust=0)

ggplot(data[-c(21,22),],aes(x=Longitude,y=Latitude,
                            color=as.factor(res[[3]][[1]][[10]]$cluster[-c(21,22)]),
                            shape=nama_kabupaten_kota))+
  geom_point(size=3)+geom_text(aes(label=data$nama_kecamatan[-c(21,22)]),
                               hjust=0, vjust=0)
aggregate(.~cluster,res[[3]][[1]][[10]]$finaldata,mean)

get_clust_info <- function(data,cluster,name1,name2){
  dt <- cbind.data.frame(data,cluster = cluster)
  print(aggregate(.~cluster,dt,mean))
  ggplot(dt,aes(x=Longitude,y=Latitude,color=as.factor(cluster),
                              shape=name1))+
    geom_point(size=3)+geom_text(aes(label=name2),
                                 hjust=0, vjust=0)
}
get_clust_info(data[-c(21,22),-c(1:3,11,18,21:28)],res[[3]][[1]][[10]]$cluster[-c(21,22)],
               data$nama_kabupaten_kota[-c(21,22)],data$nama_kecamatan[-c(21,22)])

finaldata <- cbind.data.frame(data[,-c(11,18,21:28)],
                              cluster2 = res[[3]][[1]][[10]]$cluster,
                              cluster3 = res[[3]][[2]][[10]]$cluster)

print(aggregate(.~cluster,res[[3]][[1]][[1]]$finaldata,mean))

library(foreign)
dbfjkt <- read.dbf('shp/DKI2.dbf')
head(dbfjkt[order(dbfjkt$NAME_3),])
dbfjkt <- dbfjkt[,c(1:2,34)]
head(finaldata)

library(dplyr)

sort(dbfjkt$NAME_3)
sort(finaldata$nama_kecamatan)

library(stringdist)
aa <- stringdistmatrix(finaldata$nama_kecamatan,dbfjkt$NAME_3)
finaldata$CC_3 <- dbfjkt$CC_3[apply(aa,1,which.min)]
finaldata[,c('nama_kecamatan','CC_3')]

finaldata2 <- left_join(dbfjkt,finaldata,'CC_3')
head(finaldata2)

write.dbf(finaldata2,'shp/DKI.dbf')




head(data[,-c(1:5,11,18,21:27)])
dt <- data.frame(data[,-c(1:5,11,24,21:27)],cluster=res[[8]]$cluster)
apply(aggregate(.~cluster,dt,mean),2,which.max)
